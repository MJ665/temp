<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Prioritizer</title>
</head>
<body>
    <h1>Task Prioritizer</h1>
    <div id="auth-section">
        <h2>Authentication</h2>
        <button onclick="promptAuth()">Authenticate</button>
    </div>
    <div id="task-section" style="display: none;">
        <h2>Welcome, <span id="user-display"></span>! <button onclick="logout()">Logout</button></h2>
        <h3>Add Task</h3>
        <input type="text" id="task-title" placeholder="Task Title">
        <select id="task-priority">
            <option value="High">High</option>
            <option value="Medium">Medium</option>
            <option value="Low">Low</option>
        </select>
        <input type="date" id="task-dueDate">
        <button onclick="addTask()">Add Task</button>
        <h3>Tasks</h3>
        <ul id="task-list"></ul>
    </div>

    <script>
        let userId = null;

        function promptAuth() {
            const action = prompt("Type 'CreateUser' to create an account or 'Login' to login:");
            const username = prompt("Enter your username:");
            const password = prompt("Enter your password:");
            if (action === 'CreateUser') {
                createUser(username, password);
            } else if (action === 'Login') {
                login(username, password);
            } else {
                alert("Invalid action");
            }
        }

        function createUser(username, password) {
            fetch('http://localhost:3000/createUser', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.message === 'User created') {
                    login(username, password);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function login(username, password) {
            fetch('http://localhost:3000/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message === 'Login successful') {
                    userId = data.userId;
                    document.getElementById('user-display').innerText = username;
                    document.getElementById('auth-section').style.display = 'none';
                    document.getElementById('task-section').style.display = 'block';
                    loadTasks();
                } else {
                    alert(data.message);
                }
            })
            .catch(error => console.error('Error:', error));
        }

        function logout() {
            userId = null;
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('task-section').style.display = 'none';
        }

        function loadTasks() {
            fetch(`http://localhost:3000/tasks/${userId}`)
            .then(response => response.json())
            .then(tasks => displayTasks(tasks))
            .catch(error => console.error('Error:', error));
        }

        function addTask() {
            const title = document.getElementById('task-title').value;
            const priority = document.getElementById('task-priority').value;
            const dueDate = document.getElementById('task-dueDate').value;
            fetch('http://localhost:3000/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, title, priority, dueDate })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadTasks();
                document.getElementById('task-title').value = '';
            })
            .catch(error => console.error('Error:', error));
        }

        function editTask(taskId) {
            const newTitle = prompt('Edit Task Title:');
            const newPriority = prompt('Edit Task Priority (High, Medium, Low):');
            const newDueDate = prompt('Edit Task Due Date (YYYY-MM-DD):');
            fetch(`http://localhost:3000/tasks/${taskId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title: newTitle, priority: newPriority, dueDate: newDueDate })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadTasks();
            })
            .catch(error => console.error('Error:', error));
        }

        function deleteTask(taskId) {
            fetch(`http://localhost:3000/tasks/${taskId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadTasks();
            })
            .catch(error => console.error('Error:', error));
        }

        function displayTasks(tasks) {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '';
            tasks.sort((a, b) => {
                const priorityOrder = { 'High': 1, 'Medium': 2, 'Low': 3 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            tasks.forEach(task => {
                const li = document.createElement('li');
                li.innerHTML = `${task.title} [${task.priority}] - Due: ${new Date(task.dueDate).toLocaleDateString()} 
                    <button onclick="editTask('${task._id}')">Edit</button> 
                    <button onclick="deleteTask('${task._id}')">Delete</button>`;
                taskList.appendChild(li);
            });
        }
    </script>
</body>
</html>
